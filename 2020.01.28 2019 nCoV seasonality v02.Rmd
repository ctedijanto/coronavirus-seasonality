---
title: "Coronavirus seasonality"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

# Download relevant packages
library(tidyverse)
library(EpiEstim)
library(lubridate)
library(ggpubr)
library(gridExtra)

# Read in data
setwd("/Users/ctedijanto/Documents/03 Research/09 2019 nCoV seasonality/")
us_cov_df <- read.csv("from Stephen - wuhan-master/NationalCoV.csv", header = TRUE, stringsAsFactors = FALSE)
us_ntests <- read.csv("from Stephen - wuhan-master/ntests.csv", header = TRUE, stringsAsFactors = FALSE)

virus.list <- c("CoVHKU1", "CoVNL63", "CoVOC43", "CoV229E")
```

## Introduction

The goal of this work is to describe how the effective reproduction number ($R_E$) for coronavirus evolves seasonally, and then to understand the factors underlying these changes, including depletion of susceptibles, weather patterns, school closures, etc. Eventually, we may be interested in looking at $R_E$ by subtype, age group, compare percentage of positive tests to raw number of positive tests, etc.

The following figure (data compilation and code by Stephen Kissler) shows the seasonal trends in positive tests for four different coronavirus strains in the United States from July 2016 to January 2020 (NREVSS):

```{r pos_test.prop, echo=FALSE}
# =============================================================================
# Source: data compiled by & code written by S. Kissler
# Import
# =============================================================================

us_cov_df$Week <- as_date(us_cov_df$Week)

# =============================================================================
# Plot % positive by virus over time
# =============================================================================

fignatcov <- us_cov_df %>% 
	pivot_longer(c("CoVHKU1","CoVNL63","CoVOC43","CoV229E"), names_to="Virus", values_to="PercentPositive") %>%
	ggplot(aes(x=Week, y=PercentPositive, col=Virus)) + 
		scale_color_manual(values=c("blue","red","black","magenta")) + 
		# scale_color_brewer(type="qual", palette=4) + 
		geom_point(alpha=0.8, size=0.5) +
		geom_line(alpha=0.8, size=1) + 
		theme_minimal() +
    theme(legend.position="bottom")

plot(fignatcov)
```

## Methods

We use the Wallinga-Teunis (Wallinga & Teunis, AJE 2004) method to estimate the weekly $R_E$ from time series data of the proportion and number of positive tests for each coronavirus strain. The method described by te Beest, et al. (AJE 2013) was used to translate weekly data into daily values to be used with the Wallinga-Teunis method. The weekly $R_E$ estimates are the geometric mean of the daily $R_E$ estimates. For smoothing purposes, the estimates shown are the 3-week moving geometric mean (geometric mean over daily values from the current week, week before, and week after). Code from te Beest, et al. was adapted for this analysis.

### Assumptions:
* \textit{Raw number of positive tests}: The weekly number of positive tests was estimated by multiplying the proportion of tests that were positive for each strain (shown above) by the total number of tests recorded in NREVSS (Killerby, et al. J Clin Virol 2018). Data from Killerby, et al. ranges from July 2014 to June 2017, overlapping our \%-positive data by one year. Total test numbers from the year of overlap (July 2016-June 2017) were used as estimates of the raw number of positive tests for all years of \%-positive data.  

* \textit{Serial interval}: We use the serial interval observed during the SARS outbreak in Singapore - a Weibull distribution with shape parameter $\alpha$ and scale parameter $\beta$ corresponding to mean interval of 8.4 days and standard deviation of 3.8 days (Wallinga & Teunis, AJE 2004). We set the maximum serial interval to 19 days, the 99.4th percentile of this distribution.  

* \textit{Estimating daily values from weekly data}: A spline method described in te Beest, et al. was used to estimate daily numbers of positive tests while keeping the weekly total consistent with the observed data. For the proportion of positive tests, the weekly value was used as the daily value for each day of that week.

```{r pos_test.n, include=FALSE, warning=FALSE, message=FALSE}
# Data on # of tests is from different time period than % positive data
# Use last year (52 weeks) of test #s
# Also pull in start date of each week to confirm approximate alignment
ntests_last_yr <- us_ntests[(nrow(us_ntests)-51):nrow(us_ntests),"NTESTS"]
ntests_wk_last_yr <- us_ntests[(nrow(us_ntests)-51):nrow(us_ntests),"WEEK"]
us_cov_df$ntests <- rep(ntests_last_yr, length.out=nrow(us_cov_df))
us_cov_df$ntests_week <- rep(ntests_wk_last_yr, length.out=nrow(us_cov_df))

# Create column of number of positive tests for each virus
for(v in virus.list){
  us_cov_df[,paste0(v,"_tests")] <- (us_cov_df[,v]/100)*us_cov_df[,"ntests"]
}
```

\newpage
## Estimation of $R_E$ in the US

```{r us_wt, echo=FALSE, warning=FALSE, message=FALSE}

#---------------------------------------------------------------------------------------------------------
# Prepare for R_effective estimation
#---------------------------------------------------------------------------------------------------------

NWeeks = nrow(us_cov_df)			#Number of weeks in dataset
earliest_date = as.Date(min(us_cov_df$Week))-1 #Day '0' in the dataset (assume that first date in the dataset is Day 1)
NDays = NWeeks*7
Days = as.Date(earliest_date) + c(1:NDays)
week_no = rep(1:NWeeks, each=7)

# Assume SARS generation interval distribution
# Based on data from Singapore, Weibull with mean 8.4 days and sd 3.8 days
# This mean and sd imply the following shape and scale parameters:
SARS_shape = 2.35
SARS_scale = 9.48

weibull_stop = ceiling(qweibull(0.99, shape=SARS_shape, scale=SARS_scale))

#---------------------------------------------------------------------------------------------------------
# Calculate R (based on te Beest code): calculate R using daily flu incidence data
#---------------------------------------------------------------------------------------------------------

# Calculate R_effective estimates for each viral strain
for(v in virus.list){
  
  ## Estimate daily values for number of positive tests
  WeekInc_tests <- us_cov_df[,paste0(v,"_tests")]
  
  # For nrevss, assume that data is for the week starting on the given date
  # Calculate cumulative weekly sums
  CumWeekInc_tests = c(0,cumsum(WeekInc_tests))
  
  # Fit a spline to the cumulative incidences by week (# of data points = # of weeks)
  # Using the spline, interpolate for each day (n = # of days)
  CoVspline = spline(c(0:NWeeks)*7,CumWeekInc_tests,n=NWeeks*7+1)
  DayInc_tests = diff((CoVspline$y)) # Using interpolation for cumulative incidence by day, use 'diff' to back-calc daily incidence
  DayInc_tests[DayInc_tests<0] = 0.0000001
  
  ## Estimate daily values for proportion testing positive
  WeekInc_prop <- us_cov_df[,v]
  DayInc_prop <- rep(WeekInc_prop, each=7)
  
  # Estimate daily R using Wallinga-Teunis 
  R_tests <- numeric()
  R_prop <- numeric()
  for(u in (weibull_stop+1):NDays)
  {
  	sumt_tests = 0
  	sumt_prop = 0
  	for(t in u:(u+weibull_stop))
  	{
  		suma_tests = 0
  		suma_prop = 0
  		for(a in 0:(weibull_stop)){
  		  suma_tests = DayInc_tests[t-a]*dweibull(a, shape=SARS_shape, scale=SARS_scale) + suma_tests
  		  suma_prop = DayInc_prop[t-a]*dweibull(a, shape=SARS_shape, scale=SARS_scale) + suma_prop
  		} 
  		sumt_tests = (DayInc_tests[t]*dweibull(t-u, shape=SARS_shape, scale=SARS_scale))/suma_tests + sumt_tests
  		sumt_prop = (DayInc_prop[t]*dweibull(t-u, shape=SARS_shape, scale=SARS_scale))/suma_prop + sumt_prop
  	}
  	R_tests[u] = sumt_tests
  	R_prop[u] = sumt_prop
  }
  
  # Take geometric mean over current week, and one week before + after (for smoothing), to get weekly estimates
  RWeek_tests <- numeric()
  RWeek_prop <- numeric()
  for(i in 1:NWeeks) RWeek_tests[i] = prod(as.numeric(R_tests[which(week_no==i | week_no==i+1 | week_no==i-1)]), na.rm=TRUE)^(1/sum(!is.na(R_tests[which(week_no==i | week_no==i+1 | week_no==i-1)])))
  for(i in 1:NWeeks) RWeek_prop[i] = prod(as.numeric(R_prop[which(week_no==i | week_no==i+1 | week_no==i-1)]), na.rm=TRUE)^(1/sum(!is.na(R_prop[which(week_no==i | week_no==i+1 | week_no==i-1)])))
  us_cov_df[,paste0(v,"_R_tests")] <- RWeek_tests
  us_cov_df[,paste0(v,"_R_prop")] <- RWeek_prop
}
```


```{r us_wt.plot, echo=FALSE, warning=FALSE, message=FALSE}
CoV229E_color <- "blue"
CoVHKU1_color <- "red"
CoVNL63_color <- "black"
CoVOC43_color <- "magenta"

#---------------------------------------------------------------------------------------------------------
# Create figures: Raw positive test numbers
#---------------------------------------------------------------------------------------------------------

CoV229E_tests_fig <- ggplot(data=us_cov_df, aes(x=Week, y=CoV229E_tests/100)) + 
  		geom_point(color=CoV229E_color, alpha=0.8, size=0.5) +
  		geom_line(color=CoV229E_color, alpha=0.8, size=1) + 
  		theme_bw() +
      theme(legend.position="none") +
      labs(y="Positive tests (00s)") +
      ylim(c(0,8)) +
      xlim(c(as.Date("2016-07-23"), as.Date("2019-12-28")))

CoVHKU1_tests_fig <- ggplot(data=us_cov_df, aes(x=Week, y=CoVHKU1_tests/100)) + 
  		geom_point(color=CoVHKU1_color, alpha=0.8, size=0.5) +
  		geom_line(color=CoVHKU1_color, alpha=0.8, size=1) + 
  		theme_bw() +
      theme(legend.position="none") +
      labs(y="Positive tests (00s)") +
      ylim(c(0,6)) +
      xlim(c(as.Date("2016-07-23"), as.Date("2019-12-28")))
  
CoVNL63_tests_fig <- ggplot(data=us_cov_df, aes(x=Week, y=CoVNL63_tests/100)) + 
  		geom_point(color=CoVNL63_color, alpha=0.8, size=0.5) +
  		geom_line(color=CoVNL63_color, alpha=0.8, size=1) + 
  		theme_bw() +
      theme(legend.position="none") +
      labs(y="Positive tests (00s)") +
      ylim(c(0,6)) +
      xlim(c(as.Date("2016-07-23"), as.Date("2019-12-28")))

CoVOC43_tests_fig <- ggplot(data=us_cov_df, aes(x=Week, y=CoVOC43_tests/100)) + 
  		geom_point(color=CoVOC43_color, alpha=0.8, size=0.5) +
  		geom_line(color=CoVOC43_color, alpha=0.8, size=1) + 
  		theme_bw() +
      theme(legend.position="none") +
      labs(y="Positive tests (00s)") +
      ylim(c(0,8)) +
      xlim(c(as.Date("2016-07-23"), as.Date("2019-12-28")))

#---------------------------------------------------------------------------------------------------------
# Create figures: R_E estimates by raw positive test numbers
#---------------------------------------------------------------------------------------------------------

CoV229E_R_tests_fig <- ggplot(data=us_cov_df, aes(x=Week, y=CoV229E_R_tests)) + 
  		geom_point(color=CoV229E_color, alpha=0.8, size=0.5) +
  		geom_line(color=CoV229E_color, alpha=0.8, size=1) + 
  		theme_bw() +
      theme(legend.position="none") +
      labs(y="R_effective (tests)") +
      ylim(c(0,3)) +
      xlim(c(as.Date("2016-07-23"), as.Date("2019-12-28")))

CoVHKU1_R_tests_fig <- ggplot(data=us_cov_df, aes(x=Week, y=CoVHKU1_R_tests)) + 
  		geom_point(color=CoVHKU1_color, alpha=0.8, size=0.5) +
  		geom_line(color=CoVHKU1_color, alpha=0.8, size=1) + 
  		theme_bw() +
      theme(legend.position="none") +
      labs(y="R_effective (tests)") +
      ylim(c(0,4)) +
      xlim(c(as.Date("2016-07-23"), as.Date("2019-12-28")))
  
CoVNL63_R_tests_fig <- ggplot(data=us_cov_df, aes(x=Week, y=CoVNL63_R_tests)) + 
  		geom_point(color=CoVNL63_color, alpha=0.8, size=0.5) +
  		geom_line(color=CoVNL63_color, alpha=0.8, size=1) + 
  		theme_bw() +
      theme(legend.position="none") +
      labs(y="R_effective (tests)") +
      ylim(c(0,3)) +
      xlim(c(as.Date("2016-07-23"), as.Date("2019-12-28")))
  
CoVOC43_R_tests_fig <- ggplot(data=us_cov_df, aes(x=Week, y=CoVOC43_R_tests)) + 
  		geom_point(color=CoVOC43_color, alpha=0.8, size=0.5) +
  		geom_line(color=CoVOC43_color, alpha=0.8, size=1) + 
  		theme_bw() +
      theme(legend.position="none") +
      labs(y="R_effective (tests)") +
      ylim(c(0,3)) +
      xlim(c(as.Date("2016-07-23"), as.Date("2019-12-28")))

#---------------------------------------------------------------------------------------------------------
# Create figures: proportion testing positive by strain
#---------------------------------------------------------------------------------------------------------

CoV229E_prop_fig <- ggplot(data=us_cov_df, aes(x=Week, y=CoV229E)) + 
  		geom_point(color=CoV229E_color, alpha=0.8, size=0.5) +
  		geom_line(color=CoV229E_color, alpha=0.8, size=1) + 
  		theme_bw() +
      theme(legend.position="none") +
      labs(y="% testing positive") +
      ylim(c(0,8)) +
      ggtitle("CoV229E") +
      xlim(c(as.Date("2016-07-23"), as.Date("2019-12-28")))

CoVHKU1_prop_fig <- ggplot(data=us_cov_df, aes(x=Week, y=CoVHKU1)) + 
  		geom_point(color=CoVHKU1_color, alpha=0.8, size=0.5) +
  		geom_line(color=CoVHKU1_color, alpha=0.8, size=1) + 
  		theme_bw() +
      theme(legend.position="none") +
      labs(y="% testing positive") +
      ylim(c(0,6)) +
      xlim(c(as.Date("2016-07-23"), as.Date("2019-12-28"))) +
      ggtitle("CoVHKU1")

CoVNL63_prop_fig <- ggplot(data=us_cov_df, aes(x=Week, y=CoVNL63)) + 
  		geom_point(color=CoVNL63_color, alpha=0.8, size=0.5) +
  		geom_line(color=CoVNL63_color, alpha=0.8, size=1) + 
  		theme_bw() +
      theme(legend.position="none") +
      labs(y="% testing positive") +
      ylim(c(0,6)) +
      ggtitle("CoVNL63") +
      xlim(c(as.Date("2016-07-23"), as.Date("2019-12-28")))

CoVOC43_prop_fig <- ggplot(data=us_cov_df, aes(x=Week, y=CoVOC43)) + 
  		geom_point(color=CoVOC43_color, alpha=0.8, size=0.5) +
  		geom_line(color=CoVOC43_color, alpha=0.8, size=1) + 
  		theme_bw() +
      theme(legend.position="none") +
      labs(y="% testing positive") +
      ylim(c(0,8)) +
      ggtitle("CoVOC43") +
      xlim(c(as.Date("2016-07-23"), as.Date("2019-12-28")))

#---------------------------------------------------------------------------------------------------------
# Create figures: R_E estimates by proportion testing positive
#---------------------------------------------------------------------------------------------------------
  
CoV229E_R_prop_fig <- ggplot(data=us_cov_df, aes(x=Week, y=CoV229E_R_prop)) + 
  		geom_point(color=CoV229E_color, alpha=0.8, size=0.5) +
  		geom_line(color=CoV229E_color, alpha=0.8, size=1) + 
  		theme_bw() +
      theme(legend.position="none") +
      labs(y="R_effective (% pos)") +
      ylim(c(0,3)) +
      xlim(c(as.Date("2016-07-23"), as.Date("2019-12-28")))

CoVHKU1_R_prop_fig <- ggplot(data=us_cov_df, aes(x=Week, y=CoVHKU1_R_prop)) + 
  		geom_point(color=CoVHKU1_color, alpha=0.8, size=0.5) +
  		geom_line(color=CoVHKU1_color, alpha=0.8, size=1) + 
  		theme_bw() +
      theme(legend.position="none") +
      labs(y="R_effective (% pos)") +
      ylim(c(0,4)) +
      xlim(c(as.Date("2016-07-23"), as.Date("2019-12-28")))

CoVNL63_R_prop_fig <- ggplot(data=us_cov_df, aes(x=Week, y=CoVNL63_R_prop)) + 
  		geom_point(color=CoVNL63_color, alpha=0.8, size=0.5) +
  		geom_line(color=CoVNL63_color, alpha=0.8, size=1) + 
  		theme_bw() +
      theme(legend.position="none") +
      labs(y="R_effective (% pos)") +
      ylim(c(0,3)) +
      xlim(c(as.Date("2016-07-23"), as.Date("2019-12-28")))

CoVOC43_R_prop_fig <- ggplot(data=us_cov_df, aes(x=Week, y=CoVOC43_R_prop)) + 
  		geom_point(color=CoVOC43_color, alpha=0.8, size=0.5) +
  		geom_line(color=CoVOC43_color, alpha=0.8, size=1) + 
  		theme_bw() +
      theme(legend.position="none") +
      labs(y="R_effective (% pos)") +
      ylim(c(0,3)) +
      xlim(c(as.Date("2016-07-23"), as.Date("2019-12-28")))
```

```{r CoV229E_plots, echo=FALSE, warning=FALSE, message=FALSE, fig.height=7}
grid.arrange(CoV229E_prop_fig, CoV229E_R_prop_fig, CoV229E_tests_fig, CoV229E_R_tests_fig, ncol=1)
```
\newpage
```{r CoVHKU1_plots, echo=FALSE, warning=FALSE, message=FALSE, fig.height=7}
grid.arrange(CoVHKU1_prop_fig, CoVHKU1_R_prop_fig, CoVHKU1_tests_fig, CoVHKU1_R_tests_fig, ncol=1)
```
\newpage
```{r CoVNL63_plots, echo=FALSE, warning=FALSE, message=FALSE, fig.height=7}
grid.arrange(CoVNL63_prop_fig, CoVNL63_R_prop_fig, CoVNL63_tests_fig, CoVNL63_R_tests_fig, ncol=1)
```
\newpage
```{r CoVOC43_plots, echo=FALSE, warning=FALSE, message=FALSE, fig.height=7}
grid.arrange(CoVOC43_prop_fig, CoVOC43_R_prop_fig, CoVOC43_tests_fig, CoVOC43_R_tests_fig, ncol=1)
```